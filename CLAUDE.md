# ECXIA安全管理システム - マスターコンテキスト

**最終更新：2026年2月12日**
**バージョン：1.0.0**

---

## 0. このドキュメントの目的

このファイルは、**ECXIA安全管理システム**を開発する際の**唯一の起点**です。

**Claude Codeへの指示：**
1. このファイルを最初に読む
2. `PROGRESS.md`で現在の進捗を確認する
3. 必要に応じて`docs/`配下の詳細設計書を参照する
4. 実装を開始する

---

## 1. プロジェクト概要

### 1.1 プロジェクト名

**ECXIA Safety Management System（エクシア安全管理システム）**

### 1.2 一言で言うと

**「軽貨物ドライバーの日報・点呼・点検を、LINEから入力するだけで法令を完全に守れる安全管理システム」**

### 1.3 クライアント情報

| 項目 | 内容 |
|------|------|
| 企業名 | 株式会社ECXIA（エクシア） |
| 所在地 | 千葉県市川市南八幡5-10-1 ピエール本八幡502 |
| 業種 | 軽貨物運送業（宅配便・スポット便・チャーター便・企業配送便） |
| 規模 | ドライバー20〜50名規模 |
| TEL | 047-702-8267 |
| 公式サイト | https://ekutora.com/ |

### 1.4 解決する課題

| Before（現状） | After（導入後） |
|---------------|----------------|
| 日報・点呼がアナログ（紙） | LINEから入力 → クラウド自動保存 |
| アルコールチェックを誰も見ていない | 実施者・測定値を記録、確認者を明示 |
| 法改正（令和7年4月）への未対応 | 法定項目を完全網羅、監査対応可能 |
| 未提出の把握ができない | 自動アラート → 管理者に即通知 |
| データが散在（紙・口頭・記憶） | Single Source of Truth（クラウドDB） |
| 保存期間の管理が手動 | 1年/3年の自動保存期間管理 |

### 1.5 法令根拠

**令和6年法改正（令和7年4月施行）** - 貨物軽自動車運送事業者の安全対策強化

| 法定要件 | 保存期間 | システム対応 |
|---------|---------|------------|
| 業務の記録（運転者氏名、車両番号、業務開始/終了/休憩の日時・地点、距離、経過地点） | 1年間 | 業務前/後報告 |
| 点呼記録簿（酒気帯び、疾病・疲労・睡眠不足、車両・道路・運行状況、日常点検） | 1年間 | 点呼チェック |
| 日常点検記録（エンジンルーム、ライト、タイヤ、運転席周り） | 1年間 | 日常点検表 |
| 事故の記録（乗務員氏名、発生日時・場所、概要、原因、再発防止策） | 3年間 | 事故報告 |
| 運転者に対する指導監督記録 | 3年間 | 指導記録 |

### 1.6 主要機能（8画面）

| # | 画面 | 種別 | 役割 | Phase |
|---|------|------|------|-------|
| 1 | 業務前報告フォーム | LIFF | 出勤打刻 + 点呼（乗務前） | Phase 1 |
| 2 | 日常点検フォーム | LIFF | 車両13項目チェック | Phase 1 |
| 3 | 業務後報告フォーム | LIFF | 退勤打刻 + 点呼（乗務後） | Phase 1 |
| 4 | 事故報告フォーム | LIFF | 事故発生時の記録 | Phase 1 |
| 5 | 管理ダッシュボード | Web | 本日の提出状況一覧 | Phase 1 |
| 6 | 日報一覧・詳細 | Web | ドライバー別・日付別閲覧 | Phase 1 |
| 7 | ドライバー・車両管理 | Web | マスタデータCRUD | Phase 1 |
| 8 | データエクスポート | Web | CSV出力（監査対応） | Phase 1 |

---

## 2. 絶対に守るべき設計思想（5原則）

### 原則1: Single Source of Truth（正本は1つ）

```
✅ 正しい：全ての最新状態はこのOS（データベース）に集約される
❌ 間違い：紙にも最新がある、LINEトーク履歴にも最新がある
```

**実装ルール：**
- LINEはあくまで「入力手段」と「通知手段」
- データの正本は必ずSupabase（PostgreSQL）に存在する
- 管理画面はDBの正本を表示する

### 原則2: No Manual Input（入力負荷を極小化）

```
✅ 正しい：出勤ボタン1つで日時自動記録、前回値を自動セット
❌ 間違い：毎日同じナンバープレートを手入力させる
```

**実装ルール：**
- 日時はボタンタップで自動取得（手入力させない）
- ナンバープレート等の毎日変わらない項目は前回値を自動表示
- 配送先は過去の履歴からサジェスト
- ドライバー名はLINEアカウント連携で自動取得

### 原則3: Exception Management（例外だけを見る）

```
✅ 正しい：未提出者だけアラート、普段は静か
❌ 間違い：全員分の提出状況を毎回チェック
```

**実装ルール：**
- 未提出者のみ赤色で目立たせる
- アラートには「誰が」「何を」「いつまでに」を含める
- 全員提出完了なら「本日の未提出はありません」のみ表示

### 原則4: 法令完全準拠（不足は許されない）

```
✅ 正しい：国交省の法定項目を100%カバー
❌ 間違い：便利そうな項目だけ実装して法定項目が足りない
```

**実装ルール：**
- 業務記録の6項目（§1.5参照）は全て必須入力
- 点呼の4確認事項は全て記録
- 保存期間は自動管理（通常1年、事故3年）
- データ削除は保存期間経過後も手動承認が必要

### 原則5: マルチテナント前提（他社展開を見据える）

```
✅ 正しい：全テーブルにorganization_idがある
❌ 間違い：ECXIA専用で作って後から対応
```

**実装ルール：**
- 全テーブルに`organization_id`を追加
- RLSで組織間のデータを完全分離
- 将来、他の運送会社にも同じシステムを提供可能な設計

---

## 2.5 3-AIコンセンサスによる追加設計指針（2026-02-12 合議済み）

以下はClaude Code + Codex + Geminiの3者合議で確定した設計指針。

### 2.5.1 「点呼」の法的位置づけ（重要）

**本システムは点呼内容の「記録を補助するもの」であり、点呼そのものではない。**

- 法令が求める「点呼」は管理者による運転者の状態**確認**行為
- アルコールチェックは対面またはカメラ等での確認が原則
- 管理者は記録内容に基づき、体調不良やアルコール検知時には電話等で直接対話し乗務可否を指示する**運用が別途必要**
- 提案書・マニュアルにこの区分を明記すること

### 2.5.2 PII混入防止ルール

- `event_logs.details`（JSONB）に個人情報を保存しない
- ログ生成時にPIIをマスキング（例：`"山田太郎"` → `"山***"`）
- console.log、エラーメッセージにドライバーの個人情報を含めない
- ログ出力用の共通関数を作成し、PIIフィルタを組み込む

### 2.5.3 LINE紐付けの自動化

- 管理者手動でのLINE User ID入力は**非推奨**（コピペミスのリスク）
- 推奨フロー：管理者がドライバー登録 → 専用登録URL/QRコード生成 → ドライバーがLIFFで開くと自動紐付け

### 2.5.4 オフライン対策

- LIFFフォームの入力内容を`localStorage`に定期自動保存
- LIFF起動時に未送信データがあれば復元
- 通信断やアプリクラッシュからの入力データ保護

### 2.5.5 外部バックアップ

- Supabase PITRだけでなく、定期的にCSV/JSONでエクスポート
- Supabaseとは別のストレージ（GCS等）に保管
- BCP（事業継続計画）の観点から必須

### 2.5.6 代理入力機能

- LINE/Supabase障害時の代替フロー
- 管理者がドライバーの代わりに報告を入力できる機能（`submitted_via = 'manual'`）
- 障害時の運用マニュアルを整備

### 2.5.7 休憩記録の構造化

- `rest_periods`はTEXT型ではなく**JSONB型**
- 形式：`[{start: "HH:mm", end: "HH:mm", location: "..."}]`
- 将来の勤務時間管理・改善基準告示への対応に必須

---

## 3. システムアーキテクチャ（4層モデル）

```
┌─────────────────────────────────────────────────────────────┐
│                                                               │
│    Layer D: 自動化エンジン                                    │
│    ┌─────────────────────────────────────────────────────┐   │
│    │  Supabase Edge Functions                             │   │
│    │  ├─ 朝のリマインド（毎朝8:00 LINEプッシュ通知）     │   │
│    │  ├─ 未提出アラート（9:30 / 19:00）                   │   │
│    │  ├─ 管理者サマリー通知（毎朝10:00）                  │   │
│    │  └─ 保存期間管理（月次バッチ）                       │   │
│    └─────────────────────────────────────────────────────┘   │
│                              ↑                                │
│                         Cron / Webhook                        │
│                              ↓                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│    Layer C: LINE連携サービス                                  │
│    ┌─────────────────────────────────────────────────────┐   │
│    │  LINE Messaging API                                   │   │
│    │  ├─ Webhook受信（友だち追加、メッセージ）            │   │
│    │  ├─ プッシュ通知（リマインド、アラート）             │   │
│    │  ├─ リッチメニュー（フォームへの導線）               │   │
│    │  └─ LIFF（LINE内Webフォーム）                        │   │
│    └─────────────────────────────────────────────────────┘   │
│                              ↑                                │
│                         API呼び出し                           │
│                              ↓                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│    Layer B: 運用UI                                            │
│    ┌─────────────────────────────────────────────────────┐   │
│    │  管理画面: React + TypeScript + Tailwind + shadcn/ui │   │
│    │  ├─ ダッシュボード（提出状況）                       │   │
│    │  ├─ 日報一覧・詳細                                   │   │
│    │  ├─ ドライバー・車両管理                             │   │
│    │  └─ データエクスポート                               │   │
│    │                                                       │   │
│    │  ドライバーUI: LIFF（LINE内Webアプリ）                │   │
│    │  ├─ 業務前報告フォーム                               │   │
│    │  ├─ 日常点検フォーム                                 │   │
│    │  ├─ 業務後報告フォーム                               │   │
│    │  └─ 事故報告フォーム                                 │   │
│    └─────────────────────────────────────────────────────┘   │
│                              ↑                                │
│                         Supabase Client                       │
│                              ↓                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│    Layer A: データ基盤                                        │
│    ┌─────────────────────────────────────────────────────┐   │
│    │  Supabase                                             │   │
│    │  ├─ PostgreSQL 15（データベース）                     │   │
│    │  ├─ Supabase Auth（認証 - 管理画面用）               │   │
│    │  ├─ Row Level Security（認可）                       │   │
│    │  ├─ Supabase Storage（写真等）                       │   │
│    │  └─ Supabase Edge Functions（サーバーレス）          │   │
│    └─────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 技術スタック

### 4.1 フロントエンド（管理画面）

| 技術 | 用途 | バージョン |
|-----|------|-----------|
| React | UIフレームワーク | 18.x |
| TypeScript | 型安全 | 5.x (Strict Mode) |
| Vite | ビルドツール | 5.x |
| Tailwind CSS | スタイリング | 3.x |
| shadcn/ui | UIコンポーネント | 最新 |
| TanStack Query | サーバー状態管理 | 5.x |
| TanStack Router | ルーティング | 1.x |
| React Hook Form | フォーム | 7.x |
| Zod | バリデーション | 3.x |
| date-fns | 日付処理 | 3.x |

### 4.2 フロントエンド（ドライバーUI - LIFF）

| 技術 | 用途 | 備考 |
|-----|------|------|
| LIFF SDK | LINE内Webアプリ | v2.x |
| React | UIフレームワーク | 管理画面と共有 |
| TypeScript | 型安全 | 管理画面と共有 |
| Tailwind CSS | スタイリング | モバイルファースト |

### 4.3 バックエンド

| 技術 | 用途 | 備考 |
|-----|------|------|
| Supabase | BaaS | PostgreSQL 15 |
| Supabase Auth | 認証 | 管理者ログイン用 |
| Supabase Storage | ファイル保存 | 事故写真等 |
| Row Level Security | セキュリティ | 必須 |
| Supabase Edge Functions | サーバーレス関数 | LINE Webhook, Cron |

### 4.4 LINE連携

| 技術 | 用途 | 備考 |
|-----|------|------|
| LINE Messaging API | メッセージ送受信 | Webhook + Push |
| LIFF (LINE Front-end Framework) | LINE内Webフォーム | ドライバー入力UI |
| LINE Login | ドライバー認証 | LIFF経由で自動 |
| Rich Menu | メニューUI | フォームへの導線 |

### 4.5 開発・運用

| 技術 | 用途 |
|-----|------|
| pnpm | パッケージマネージャー |
| ESLint + Prettier | コード品質 |
| Vitest | ユニットテスト |
| Playwright | E2Eテスト |
| GitHub Actions | CI/CD |
| Vercel | フロントエンドホスティング |

---

## 5. ユーザー種別と権限

### 5.1 ロール一覧

| ロール | 説明 | アクセス方法 |
|--------|------|-------------|
| **org_admin** | 管理者（ECXIA経営者・安全管理者） | Web管理画面（Supabase Auth） |
| **manager** | 運行管理担当 | Web管理画面（Supabase Auth） |
| **driver** | ドライバー | LINE LIFF |

### 5.2 権限マトリクス

| 機能 | org_admin | manager | driver |
|------|-----------|---------|--------|
| ダッシュボード（全員） | ✅ | ✅ | ❌ |
| 日報閲覧（全員） | ✅ | ✅ | ❌ |
| 日報入力（自分） | ❌ | ❌ | ✅（LINE） |
| ドライバー管理 | ✅ | 閲覧のみ | ❌ |
| 車両管理 | ✅ | 閲覧のみ | ❌ |
| データエクスポート | ✅ | ✅ | ❌ |
| LINE一斉配信 | ✅ | ✅ | ❌ |
| 事故報告入力 | ❌ | ❌ | ✅（LINE） |
| 事故報告閲覧 | ✅ | ✅ | ❌ |
| システム設定 | ✅ | ❌ | ❌ |

---

## 6. コーディング規約

### 6.1 TypeScript

```typescript
// ✅ 良い例：型を明示、nullを考慮
interface Driver {
  id: string;
  organizationId: string; // 必須：マルチテナント
  lineUserId: string;
  name: string;
  phone: string | null;
  status: 'active' | 'inactive';
  createdAt: Date;
  updatedAt: Date;
}

// ❌ 悪い例：any使用、organizationIdなし
interface Driver {
  id: any;
  name: string;
}
```

### 6.2 命名規則

| 対象 | 規則 | 例 |
|-----|------|-----|
| 変数・関数 | camelCase | `driverList`, `getDriverById` |
| コンポーネント・型 | PascalCase | `DriverCard`, `PreWorkReport` |
| 定数 | UPPER_SNAKE_CASE | `MAX_ALCOHOL_LEVEL` |
| ファイル（コンポーネント） | PascalCase.tsx | `DriverCard.tsx` |
| ファイル（その他） | camelCase.ts | `useDriver.ts` |
| DBテーブル | snake_case | `pre_work_reports` |
| DBカラム | snake_case | `organization_id` |

### 6.3 絶対ルール

| # | ルール | 理由 |
|---|--------|------|
| 1 | `any`型は使用禁止 | 型安全性を保つ |
| 2 | 全テーブルに`organization_id`を追加 | マルチテナント対応 |
| 3 | 全テーブルにRLSを設定 | セキュリティ |
| 4 | 全API呼び出しにtry-catch | エラーハンドリング |
| 5 | コミットメッセージはConventional Commits | 履歴の可読性 |
| 6 | LINE APIトークンは環境変数管理 | 漏洩防止 |

### 6.4 コーディング時の17項目チェックリスト

**コードを書くとき・レビューするとき、必ずこの17項目を意識すること。**

#### A. 基本チェック（4項目）

| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 1 | **重大バグ** | ロジックエラー、クラッシュの可能性、無限ループ、未処理のPromise |
| 2 | **セキュリティ脆弱性** | XSS、CSRF、SQLインジェクション、認証バイパス、OWASP Top 10 |
| 3 | **設計書との矛盾** | CLAUDE.mdの5原則違反、マルチテナント原則違反、法令準拠違反 |
| 4 | **テストカバレッジ** | 変更箇所の全パス（正常系・異常系・境界値）をテストしているか |

#### B. 再発防止チェック（6項目）

| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 5 | **organization_idフィルタ漏れ** | Supabaseクエリの全SELECT/INSERT/UPDATE/DELETEにorganization_idフィルタがあるか |
| 6 | **any型の使用** | TypeScriptで`any`型を使っていないか |
| 7 | **RLSポリシー整合** | 新規テーブルにRLSが有効化されているか |
| 8 | **PII漏洩** | console.log、エラーメッセージにドライバーの個人情報が含まれていないか |
| 9 | **Supabaseクライアント使い分け** | 管理操作にsupabaseAdmin、ユーザー操作にsupabase(auth付き)を正しく使い分けているか |
| 10 | **データ整合性** | 必須フィールドのnullチェック。法定項目の未入力許可がないか |

#### C. 未然防止チェック（6項目）

| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 11 | **リソースリーク** | useEffect内のクリーンアップ、LIFFのclose処理 |
| 12 | **エラーハンドリング漏れ** | try-catchなしのSupabase/LINE API呼び出しがないか |
| 13 | **N+1クエリ** | ループ内で1件ずつクエリを発行していないか |
| 14 | **冪等性** | 同じフォーム送信が2回来ても安全か。ボタンの二重タップ防止があるか |
| 15 | **マイグレーション安全性** | SQLが冪等か（IF NOT EXISTS等） |
| 16 | **ハードコード検出** | LINE Channel Secret、Access Token等が環境変数でなく直書きされていないか |

#### D. 横展開チェック（1項目）

| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 17 | **横展開** | 変更箇所と同じパターンが他にもある場合、全て修正されているか |

---

## 7. データベース設計（概要）

### 7.1 テーブル一覧（17テーブル）

| # | テーブル | 役割 | 保存期間 |
|---|---------|------|---------|
| 1 | organizations | 組織（テナント） | 永続 |
| 2 | admin_users | 管理者ユーザー | 永続 |
| 3 | drivers | ドライバー情報 + LINE連携 | 永続 |
| 4 | vehicles | 車両情報 | 永続 |
| 5 | pre_work_reports | 業務前報告（点呼 - 乗務前） | 1年 |
| 6 | post_work_reports | 業務後報告（点呼 - 乗務後） | 1年 |
| 7 | daily_inspections | 日常点検記録 | 1年 |
| 8 | accident_reports | 事故報告 | 3年 |
| 9 | accident_photos | 事故写真メタデータ | 3年 |
| 10 | driver_guidance_records | 指導監督記録（法定） | 3年 |
| 11 | aptitude_tests | 適性診断記録（法定） | 3年 |
| 12 | safety_manager_trainings | 安全管理者講習記録 | 永続 |
| 13 | line_broadcasts | LINE一斉配信記録 | 1年 |
| 14 | line_broadcast_targets | 配信対象ドライバー | 1年 |
| 15 | event_logs | 監査ログ | 3年 |

### 7.2 必須カラム（全テーブル共通）

```sql
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
```

### 7.3 RLS + 認証アーキテクチャ

```
管理者（Web管理画面）→ Supabase Auth → RLSで組織分離
ドライバー（LIFF）   → LINE Login  → Edge Function(service_role)経由でDB操作
```

**重要：LIFFはLINE Loginであり、Supabase Authではない。**
- ドライバーからの書き込みはクライアント直書き禁止
- Edge Function内でIDトークンを検証 → driver_idを確定 → service_roleでINSERT
- 管理者のSELECTのみRLSで制御
- 報告テーブルは複合FK `(driver_id, organization_id)` でクロステナント汚染を防止

**詳細：** `docs/06_DATABASE_DESIGN.md`

---

## 8. LINE連携設計（概要）

### 8.1 ドライバーの認証フロー（3-AIコンセンサス反映）

```
【初回登録フロー】
1. 管理者がWeb管理画面でドライバーを登録
2. システムが一意のregistration_tokenを生成 → 登録用QRコード/URLを発行
3. ドライバーがLINE公式アカウントを友だち追加
4. ドライバーが登録用URLをLIFFで開く
5. Edge FunctionがLINE IDトークンを検証 → LINE User IDを取得
6. registration_tokenからドライバーを特定 → line_user_idを自動紐付け
7. registration_tokenをNULLにする（使い捨て）
※ 管理者の手動ID入力は不要（コピペミス防止）

【日常利用フロー】
1. ドライバーがリッチメニューからLIFFフォームを開く
2. LIFF SDKがLINE Loginで自動認証 → IDトークン取得
3. Edge FunctionがIDトークンを検証（LINE API経由）
4. line_user_idからドライバーを特定、organization_idを確定
5. Edge Function(service_role)がDBにINSERT（RLSバイパス）
6. Function内でorganization_id整合を検証（クロステナント防止）
```

**セキュリティ原則：**
- LIFFクライアントから直接Supabase DBに書き込まない
- IDトークンはサーバー側（Edge Function）で必ず検証する
- クライアントで取得したプロフィール情報をサーバーに送らない（LINE公式ガイドライン準拠）

### 8.2 リッチメニュー構成

```
┌─────────────────────────────────┐
│         ECXIA安全管理            │
├────────────┬────────────────────┤
│  🚛 出勤   │   📋 日常点検     │
│  業務前報告  │   車両点検表      │
├────────────┼────────────────────┤
│  🏁 退勤   │   ⚠️ 事故報告    │
│  業務後報告  │   事故発生時      │
└────────────┴────────────────────┘
```

### 8.3 プッシュ通知スケジュール

| 時刻 | 対象 | 内容 |
|------|------|------|
| 08:00 | 全ドライバー | 「おはようございます。業務前報告をお願いします」 |
| 09:30 | 業務前未提出者 | 「業務前報告が未提出です。提出をお願いします」 |
| 19:00 | 業務後未提出者 | 「業務後報告が未提出です。提出をお願いします」 |
| 10:00 | 管理者 | 「本日の提出状況：○名提出 / ○名未提出」 |

---

## 9. セキュリティ要件

### 9.1 認証

| 項目 | 仕様 |
|-----|------|
| 管理者認証 | Supabase Auth（メール/パスワード） |
| ドライバー認証 | LINE Login（LIFF経由） |

### 9.2 認可

| 項目 | 仕様 |
|-----|------|
| 認可方式 | Row Level Security (RLS) |
| 組織分離 | organization_idで完全分離 |
| ロール管理 | admin_users.roleで管理 |

### 9.3 絶対にやってはいけないこと

| # | 禁止事項 | 理由 |
|---|---------|------|
| 1 | RLSなしでテーブルを作成 | 他組織のデータが見える |
| 2 | organization_idなしでテーブルを作成 | マルチテナント崩壊 |
| 3 | LINE Channel SecretやAccess Tokenをコードに直書き | 漏洩リスク |
| 4 | ドライバーの個人情報をログに出力 | PII漏洩 |
| 5 | 法定項目を任意入力にする | 法令違反 |

---

## 10. 開発フロー（4層防御）

### Git絶対ルール
- **mainブランチに直接pushしない。必ずfeatureブランチ→PR**

```
[Layer 1: 予防] コード作成時に17項目チェックリスト（§6.4）を意識
    ↓
[Layer 2: 検出] commit → push → Codex 2パスレビュー（17項目×2回）→ PASS必須
    ↓
CI（テスト・型チェック）→ PR作成
    ↓
[Layer 2.5: マルチAI合議] バグ修正時はCodex + Claude + Gemini に同じデータを見せて合議
    ↓
[Layer 3: 確認] マージ後・デプロイ前に pre_deploy_check.sh を実行
```

### 鉄則#11: バグ修正は計測が先、推測で直すな

| Step | やること | 禁止事項 |
|------|---------|---------|
| 1. 計測 | 診断ログだけを入れてデプロイ | コードの修正をしてはいけない |
| 2. 観察 | 本番ログを読んで実データ取得 | 推測で原因を決めつけてはいけない |
| 3. 合議 | Codex + Claude + Geminiに同じログを見せて3者合意 | 自分一人で修正着手してはいけない |
| 4. 修正 | 証拠と合議に基づいて原因箇所だけを修正 | 複数の推測修正を混ぜてはいけない |
| 5. 検証 | デプロイ後にログで改善を確認 | 「直したはず」で終わらせてはいけない |

### コミットメッセージ

```
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

---

## 11. ディレクトリ構成（予定）

```
ecxia-safety/
├── CLAUDE.md                    # このファイル
├── PROGRESS.md                  # 進捗管理
├── package.json
├── tsconfig.json
├── vite.config.ts
├── vitest.config.ts
├── tailwind.config.js
├── .env.example
├── .env.local                   # LINE Channel Secret等（Git除外）
├── docs/
│   ├── 01_PROJECT_OVERVIEW.md
│   ├── 06_DATABASE_DESIGN.md
│   ├── 07_SCREEN_DESIGN.md
│   ├── 08_LINE_INTEGRATION.md
│   └── 12_SECURITY.md
├── src/
│   ├── app/                     # 管理画面アプリ
│   │   ├── routes/              # TanStack Router
│   │   ├── components/          # UIコンポーネント
│   │   └── layouts/             # レイアウト
│   ├── liff/                    # LIFFアプリ（ドライバーUI）
│   │   ├── pages/               # フォーム画面
│   │   ├── components/          # LIFF用コンポーネント
│   │   └── hooks/               # LIFF用フック
│   ├── lib/                     # 共通ライブラリ
│   │   ├── supabase.ts          # Supabaseクライアント
│   │   ├── line.ts              # LINE API クライアント
│   │   └── validations/         # Zodスキーマ
│   ├── services/                # ビジネスロジック
│   │   ├── drivers.ts
│   │   ├── vehicles.ts
│   │   ├── preWorkReports.ts
│   │   ├── postWorkReports.ts
│   │   ├── dailyInspections.ts
│   │   ├── accidentReports.ts
│   │   └── notifications.ts
│   ├── hooks/                   # カスタムフック
│   └── types/                   # 型定義
├── supabase/
│   ├── migrations/              # DBマイグレーション
│   └── functions/               # Edge Functions
│       ├── line-webhook/        # LINE Webhook受信
│       ├── morning-reminder/    # 朝のリマインド
│       └── check-submissions/   # 未提出チェック
├── scripts/
│   ├── codex_review_loop.sh
│   ├── pre_deploy_check.sh
│   └── setup_hooks.sh
└── tests/
    ├── unit/
    ├── integration/
    └── e2e/
```

---

## 12. 契約・予算情報

| 項目 | 内容 |
|------|------|
| クライアント | 株式会社ECXIA |
| 納期 | 2025年5月 |
| 開発元 | 株式会社ソウルシンクス |

---

## 13. トラブルシューティング

| 問題 | 参照先 |
|-----|--------|
| 全体像が分からない | このファイル (CLAUDE.md) |
| 今何をすべきか分からない | PROGRESS.md |
| DBの設計が分からない | docs/06_DATABASE_DESIGN.md |
| LINE連携の仕様が分からない | docs/08_LINE_INTEGRATION.md |
| 画面の仕様が分からない | docs/07_SCREEN_DESIGN.md |

---

**このドキュメントはECXIA安全管理システムの唯一の起点です。**
**迷ったらここに戻ってください。**
